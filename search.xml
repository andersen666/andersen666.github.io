<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>随笔</title>
      <link href="/2019/08/03/%E9%9A%8F%E7%AC%94/"/>
      <url>/2019/08/03/%E9%9A%8F%E7%AC%94/</url>
      
        <content type="html"><![CDATA[<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><div id="hbe-security">  <div class="hbe-input-container">  <input type="password" class="hbe-form-control" id="pass" placeholder="Please enter the password to read the blog." />    <label for="pass">Please enter the password to read the blog.</label>    <div class="bottom-line"></div>  </div></div><div id="decryptionError" style="display: none;">Incorrect Password!</div><div id="noContentError" style="display: none;">No content to display!</div><div id="encrypt-blog" style="display:none">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</div><script src="/lib/crypto-js.js"></script><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>事务与嵌套事务</title>
      <link href="/2019/07/28/%E4%BA%8B%E5%8A%A1%E4%B8%8E%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1/"/>
      <url>/2019/07/28/%E4%BA%8B%E5%8A%A1%E4%B8%8E%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><p>当我们在银行系统中，我们需要的功能是张三转给李四150元，李四收到张三150元。我们新建账户表Test_Tran，因为在实际情况中，钱数在银行卡内是&gt;0  的,所以添加check约束 Money&gt;0。我们会采用一下语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> Test_Tran <span class="keyword">SET</span> Money=Money<span class="number">-150</span> <span class="keyword">WHERE</span>  <span class="keyword">Id</span>=<span class="number">1</span></span><br><span class="line"><span class="keyword">UPDATE</span>  dbo.Test_Tran  <span class="keyword">SET</span> Money=Money+<span class="number">150</span> <span class="keyword">WHERE</span>  <span class="keyword">Id</span>=<span class="number">2</span></span><br></pre></td></tr></table></figure><p>但事实如果A卡内没有150元，更新就会失败，但是第二个会更新成功,导致银行亏本。。</p><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fnbazluyj210a04ot8w.jpg" alt></p><p>所以我们想让这两句话作为一个整体来执行，要么都成功，要么都失败<br>        所以采用事务原理，引出事务的概念</p><h5 id="事务（Transaction）是并发控制的基本单位。"><a href="#事务（Transaction）是并发控制的基本单位。" class="headerlink" title="事务（Transaction）是并发控制的基本单位。"></a>事务（Transaction）是并发控制的基本单位。</h5><h6 id="特性：-ACID"><a href="#特性：-ACID" class="headerlink" title="特性：(ACID)"></a>特性：(ACID)</h6><ul><li>Atomic（原子性）：事务中包含的操作被看做一个逻辑单元，这个逻辑单元中的操作要么全部成功，要么全部失败。</li><li>Consistency（一致性）：只有合法的数据可以被写入数据库，否则事务应该将其回滚到最初状态,类似于约束 。</li><li>Isolation（隔离性）：事务允许多个用户对同一个数据进行并发访问，而不破坏数据的正确性和完整性。同时，并行事务的修改必须与其他并行事务的修改相互独立。</li><li>Durability（持久性）：事务结束后，事务处理的结果必须能够得到固化。</li></ul><p>对于<strong>隔离性</strong>我们可以举例</p><p>如果我们想删除一张表，利用事务，假设我们在一个查询窗口执行下面命令</p><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fnbta9vxj20ds04rweg.jpg" alt></p><p>我们需要知道此时事务还没有完成，如果我们在另一个窗口 直接查询该表，则会出现下面情况：</p><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fncagq39j20ai0173ya.jpg" alt></p><p>执行所花时间一直在增长，没有结果，也没有消息。此时这个进程在等待另一个进程操作完成。 </p><p>一旦我在第一个 SSMS 执行ROLLBACK后，就会很快可以查询到，这就是隔离性。</p><h6 id="事务基本语句"><a href="#事务基本语句" class="headerlink" title="事务基本语句"></a>事务基本语句</h6><p>开始事物：BEGIN TRANSACTION </p><p>提交事物：COMMIT TRANSACTION </p><p>回滚事务：ROLLBACK TRANSACTION </p><p>保存事务  SAVE TRANSACTION </p><p>我们此时回到最初想要的功能，张三转账150给李四，李四收到张三，我们可以采用以下事务</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>  TRAN  <span class="keyword">TEST</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">Errors</span> <span class="built_in">INT</span> </span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">Errors</span>=<span class="number">0</span></span><br><span class="line"><span class="keyword">UPDATE</span> Test_Tran  <span class="keyword">SET</span> Money=Money<span class="number">-150</span> <span class="keyword">WHERE</span>  <span class="keyword">Id</span>=<span class="number">1</span></span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">Errors</span>=@@<span class="keyword">ERROR</span>+@<span class="keyword">Errors</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> Test_Tran  <span class="keyword">SET</span> Money=Money+<span class="number">150</span> <span class="keyword">WHERE</span>  <span class="keyword">Id</span>=<span class="number">2</span></span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">Errors</span>=@@<span class="keyword">ERROR</span>+@<span class="keyword">Errors</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span>  @<span class="keyword">Errors</span> &lt;&gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">PRINT <span class="string">'FAIL'</span></span><br><span class="line"><span class="keyword">ROLLBACK</span></span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ELSE</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">PRINT <span class="string">'SUCESS'</span></span><br><span class="line"><span class="keyword">COMMIT</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure><p>如果此时张三账户中没有150元可以转账给李四，则会报错</p><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fncpw1gfj211e06o0t0.jpg" alt></p><p>这样我们就完成了事务的基本操作。</p><h4 id="嵌套事务"><a href="#嵌套事务" class="headerlink" title="嵌套事务"></a>嵌套事务</h4><p>在这之前我们需要先了解 @@TRANCOUNT <a href="https://docs.microsoft.com/zh-cn/sql/t-sql/functions/trancount-transact-sql?view=sql-server-2017" target="_blank" rel="noopener">官方文档 </a>。得出基本的结论如下</p><p>BEGIN TRANSACTION 语句将 @@TRANCOUNT 增加 1。</p><p>COMMIT TRANSACTION 将 @@TRANCOUNT 递减 1。</p><p> ROLLBACK TRANSACTION 将 @@TRANCOUNT 递减到 0。</p><p>*<em>ROLLBACK TRANSACTION savepoint_name 除外它不影响 @@TRANCOUNT *</em> </p><p>我们可与通过一下来进行验证，先看<em>提交事务操作</em></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span> TRAN A</span><br><span class="line">PRINT <span class="string">'开始A事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span> TRAN B</span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'开始B事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"></span><br><span class="line">       <span class="keyword">INSERT</span>  dbo.test <span class="keyword">SELECT</span> <span class="number">7</span>,<span class="number">7</span>,<span class="string">'G'</span></span><br><span class="line"> <span class="keyword">COMMIT</span> </span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'提交A事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"><span class="keyword">COMMIT</span> </span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'提交B事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br></pre></td></tr></table></figure><p>这是最简单的提交事务，不包含回滚等，可以得出结果</p><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fndcritdj20bn04rdg1.jpg" alt></p><p>再看<em>回滚事务操作</em>，这里ROLLBACK  这里就会分两种情况   在外部和内部</p><p>当在<strong>外部</strong>时候我们可以来例证</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span> TRAN A</span><br><span class="line">PRINT <span class="string">'开始A事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span> TRAN B</span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'开始B事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"></span><br><span class="line">       <span class="keyword">INSERT</span>  dbo.test <span class="keyword">SELECT</span> <span class="number">8</span>,<span class="number">8</span>,<span class="string">'G'</span></span><br><span class="line"> <span class="keyword">COMMIT</span> </span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'提交A事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"><span class="keyword">ROLLBACK</span> </span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'回滚B事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br></pre></td></tr></table></figure><p>这里外部已经回滚，但是我们需要理解的是，<strong>当外部回滚，内部的也会回滚，纵使内部已经提交</strong></p><p>我们可以通过查询test 表来验证这一点</p><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fne6e6k5j20c0089jr8.jpg" alt></p><p>当在<strong>内部</strong>时候我们也可以来例证</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span> TRAN A</span><br><span class="line">PRINT <span class="string">'开始A事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span> TRAN B</span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'开始B事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"></span><br><span class="line">       <span class="keyword">INSERT</span>  dbo.test <span class="keyword">SELECT</span> <span class="number">8</span>,<span class="number">8</span>,<span class="string">'G'</span></span><br><span class="line"> <span class="keyword">ROLLBACK</span>  </span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'回滚A事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"><span class="keyword">COMMIT</span> </span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'提交B事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fneojfiaj20l407m3z2.jpg" alt></p><p>这是我们可以得出结论 在内部是无法rollback 的，因为会直接将其归0，然而commit会减1，再次commit就会出现0-1=-1值，但是@@TRANCOUNT是不允许的。从而报错。</p><p>但是我们想回滚内部事务么办？这时候就需要 save 让其返回一个保存点。</p><p>但是需要注意的是 这样返回的@@TRANCOUNT值是不变的。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">--测试返回点</span></span><br><span class="line"><span class="keyword">BEGIN</span> TRAN A</span><br><span class="line">PRINT <span class="string">'开始A事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span> TRAN B</span><br><span class="line"></span><br><span class="line"><span class="keyword">SAVE</span> TRAN B_SAVE</span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'开始B事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"></span><br><span class="line">       <span class="keyword">INSERT</span>  dbo.test <span class="keyword">SELECT</span> <span class="number">8</span>,<span class="number">8</span>,<span class="string">'G'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ROLLBACK</span> TRAN   B_SAVE</span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'回滚A事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br><span class="line"><span class="keyword">COMMIT</span> </span><br><span class="line"></span><br><span class="line">PRINT <span class="string">'提交B事务@@TRANCOUNT全局变量值是'</span> + <span class="keyword">CAST</span>(@@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>))</span><br></pre></td></tr></table></figure><p>我们直接看结果</p><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fnf6he33j20e90633yr.jpg" alt></p><p>这时候我们查看表格也  生成该语句<code>INSERT  dbo.test SELECT 8,8,&#39;G&#39;</code>，看似没有问题，但是我们需要注意的一个问题是最后提交事务后全局 @@TRANCOUNT值=1 这是有问题的，说明还是有事务在系统中，这样我们在关闭窗口会提示</p><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fnfjxtzxj20pe05t74b.jpg" alt></p><p>这个我们暂时不考虑，后面会说到。起码来说，我们达到了回滚内部事务的目的。</p><p>实际情况中，我们经常遇到的是父存储过程调用子存储过程，而且父，子存储过程都存在事务<br> 我们可以用以下举例，test表中，我们限制id列为主键。</p><ul><li><p>内部存储过程主要用于插入值，并返回一个值给外部 </p></li><li><p>外部存储过程则通过传进来的值正确则插入，不正确则回滚</p><p>我们先看 <em>外部存储过程</em></p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> [test1]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="comment">/****** Object:  StoredProcedure [dbo].[outertran]    Script Date: 2019-07-28 10:11:48 ******/</span></span><br><span class="line"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">PROCEDURE</span> [dbo].[outertran]</span><br><span class="line">    @<span class="keyword">ID</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">    @UserID <span class="built_in">BIGINT</span>,</span><br><span class="line">    @<span class="keyword">Name</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line"><span class="keyword">AS</span> </span><br><span class="line">    <span class="keyword">DECLARE</span> @TRANCOUNT <span class="built_in">int</span>=(<span class="keyword">select</span> @@TRANCOUNT)</span><br><span class="line">    PRINT <span class="string">'未进入父事务前全局@@TRANCOUNT:'</span>+<span class="keyword">CAST</span>(@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>))</span><br><span class="line">    </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">BEGIN</span> TRAN </span><br><span class="line">    <span class="keyword">SET</span> @TRANCOUNT=(<span class="keyword">select</span> @@TRANCOUNT) </span><br><span class="line">    PRINT <span class="string">'进入父事务后全局@@TRANCOUNT:'</span>+<span class="keyword">CAST</span>(@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>))    </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">DECLARE</span> @<span class="keyword">result</span> <span class="built_in">INT</span></span><br><span class="line"></span><br><span class="line">    EXEC @<span class="keyword">result</span> = innertran @<span class="keyword">ID</span> = @<span class="keyword">ID</span>, @UserID = @UserID, @<span class="keyword">Name</span> =@<span class="keyword">Name</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">IF</span> ( @<span class="keyword">result</span> &lt;= <span class="number">0</span> ) </span><br><span class="line">        <span class="keyword">BEGIN</span></span><br><span class="line">            <span class="keyword">ROLLBACK</span> TRAN  ;</span><br><span class="line">            <span class="keyword">SET</span> @TRANCOUNT=(<span class="keyword">select</span> @@TRANCOUNT) </span><br><span class="line">            PRINT <span class="string">'回滚父事务后全局@@TRANCOUNT:'</span>+<span class="keyword">CAST</span>(@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>)) </span><br><span class="line">                        </span><br><span class="line">            <span class="keyword">RETURN</span> ;</span><br><span class="line">        <span class="keyword">END</span> </span><br><span class="line">    <span class="keyword">COMMIT</span> TRAN </span><br><span class="line">    <span class="keyword">SET</span> @TRANCOUNT=(<span class="keyword">select</span> @@TRANCOUNT) </span><br><span class="line">    PRINT <span class="string">'提交父事务后全局@@TRANCOUNT:'</span>+<span class="keyword">CAST</span>(@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>))</span><br></pre></td></tr></table></figure><p> 再看 <em>内部存储过程</em></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> [test1]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="comment">/****** Object:  StoredProcedure [dbo].[innertran]    Script Date: 2019-07-28 14:29:03 ******/</span></span><br><span class="line"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="comment">--内层事务存储过程，演示如何处理才能在嵌套的事务存储过程中正确处理事务</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">PROCEDURE</span> [dbo].[innertran]</span><br><span class="line">    @<span class="keyword">ID</span> <span class="built_in">BIGINT</span> ,</span><br><span class="line">    @UserID <span class="built_in">BIGINT</span> ,</span><br><span class="line">    @<span class="keyword">Name</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line"><span class="keyword">AS</span> </span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> @TRANCOUNT <span class="built_in">int</span>=(<span class="keyword">select</span> @@TRANCOUNT)</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">SET</span> XACT_ABORT <span class="keyword">ON</span></span><br><span class="line">        <span class="keyword">SET</span> @TRANCOUNT=(<span class="keyword">select</span> @@TRANCOUNT)</span><br><span class="line">        PRINT <span class="string">'未进入子事务前全局@@TRANCOUNT'</span>+<span class="keyword">CAST</span>(@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>))    </span><br><span class="line">        <span class="keyword">BEGIN</span> TRAN tran1      <span class="comment">--开始事务 </span></span><br><span class="line">       <span class="comment">--SAVE TRAN tranpoint   --保存事务点</span></span><br><span class="line">        <span class="keyword">SET</span> @TRANCOUNT=(<span class="keyword">select</span> @@TRANCOUNT)</span><br><span class="line">        PRINT <span class="string">'进入子事务后全局@@TRANCOUNT'</span>+<span class="keyword">CAST</span>(@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>))    </span><br><span class="line">       </span><br><span class="line">        <span class="keyword">IF</span>(<span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> TOP <span class="number">1</span> * <span class="keyword">FROM</span> dbo.test <span class="keyword">WHERE</span> <span class="keyword">ID</span>=@<span class="keyword">ID</span>))    </span><br><span class="line">        <span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">ROLLBACK</span> TRAN </span><br><span class="line">                <span class="comment">--ROLLBACK TRAN tranpoint ;   --回滚保存点的事务   </span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">SET</span> @TRANCOUNT=(<span class="keyword">select</span> @@TRANCOUNT)  </span><br><span class="line">                PRINT <span class="string">'只是回滚子事务后全局@@TRANCOUNT'</span>+<span class="keyword">CAST</span>(@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>))  </span><br><span class="line"><span class="comment">--最好办法就是保存该事务，提交该事务</span></span><br><span class="line">                <span class="comment">--COMMIT TRAN tran1 ;            --提示当前事务</span></span><br><span class="line">  <span class="keyword">SET</span> @TRANCOUNT=(<span class="keyword">select</span> @@TRANCOUNT)  </span><br><span class="line">                PRINT <span class="string">'回滚子事务提交后全局@@TRANCOUNT'</span>+<span class="keyword">CAST</span>(@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>))    </span><br><span class="line">                <span class="keyword">SET</span> @TRANCOUNT=(<span class="keyword">select</span> @@TRANCOUNT)  </span><br><span class="line">                PRINT <span class="string">'回滚子事务后全局@@TRANCOUNT'</span>+<span class="keyword">CAST</span>(@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>))     </span><br><span class="line">                          </span><br><span class="line">                <span class="keyword">RETURN</span> <span class="number">0</span> ;  </span><br><span class="line">        <span class="keyword">END</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">--插表开始</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">INSERT</span>  dbo.test</span><br><span class="line">                ( <span class="keyword">ID</span>, UserID, <span class="keyword">Name</span>)</span><br><span class="line">        <span class="keyword">VALUES</span>  ( @<span class="keyword">ID</span>, </span><br><span class="line">                  @UserID,</span><br><span class="line">                  @<span class="keyword">Name</span>  </span><br><span class="line">                  )</span><br><span class="line">        <span class="comment">--插表结束</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">IF</span> @@<span class="keyword">error</span> &lt;&gt; <span class="number">0</span> </span><br><span class="line">            <span class="keyword">BEGIN</span>  </span><br><span class="line">                <span class="keyword">ROLLBACK</span> TRAN tranpoint ; <span class="comment">--回滚保存点的事务   </span></span><br><span class="line">                <span class="keyword">COMMIT</span> TRAN tran1 ;          <span class="comment">--提示当前事务  </span></span><br><span class="line">                <span class="keyword">SET</span> @TRANCOUNT=(<span class="keyword">select</span> @@TRANCOUNT)  </span><br><span class="line">                PRINT <span class="string">'回滚子事务后全局@@TRANCOUNT'</span>+<span class="keyword">CAST</span>(@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>))     </span><br><span class="line">                                         </span><br><span class="line">                <span class="keyword">RETURN</span> <span class="number">0</span>;  </span><br><span class="line">            <span class="keyword">END</span>        </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">COMMIT</span> TRAN tran1 ;    </span><br><span class="line">        <span class="keyword">SET</span> XACT_ABORT <span class="keyword">OFF</span>;    </span><br><span class="line">        <span class="keyword">SET</span> @TRANCOUNT=(<span class="keyword">select</span> @@TRANCOUNT)  </span><br><span class="line">        PRINT <span class="string">'提交子事务后全局@@TRANCOUNT'</span>+<span class="keyword">CAST</span>(@TRANCOUNT <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>))</span><br><span class="line">           </span><br><span class="line">        <span class="keyword">RETURN</span> <span class="number">1</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">END</span></span><br></pre></td></tr></table></figure><p>我们可以看到 当我们传进来3个值 @ID, @UserID,@Name   后 进入事务开始执行内部存储过程。</p><p>在进行内部存储过程执行中，我们先判定这个表中是否有相同的Id，因为我们采用id为主键,如果有则回滚事务，返回0 给外部存储过程。没有返回1给外部存储过程。</p><p>简化内存储过程判断主键插入是否相同code</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">If EXISTS(<span class="keyword">SELECT</span> TOP <span class="number">1</span> * <span class="keyword">FROM</span> dbo.test <span class="keyword">WHERE</span> <span class="keyword">ID</span>=@<span class="keyword">ID</span>))    </span><br><span class="line">        <span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">ROLLBACK</span> TRAN </span><br><span class="line">                <span class="keyword">RETURN</span> <span class="number">0</span> ;  </span><br><span class="line">        <span class="keyword">END</span></span><br></pre></td></tr></table></figure><p>我们来进行实际的正常插表操作（插入表中未插入的id）</p><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fng0cxt4j20f607ljrp.jpg" alt></p><p>正常是可以走通 的， 但是当我们想实验如果插入一次重复的主键id，实验是否会回滚。</p><p>but。。。。。</p><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fnge5dcdj20rb092my6.jpg" alt></p><p>我们可以观察@@TRANCOUNT在进入子存储过程开启事务后，直接内部ROOLBACK,@@TRANCOUNT,直接归0.当前会报错,类似上面的AB事务的例子。</p><p>*<em>所以这时我们理所想到 save *</em></p><p>我们就会修改一下内存储过程代码（简化）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">BEGIN</span> TRAN tran1      <span class="comment">--开始事务 </span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">SAVE</span> TRAN tranpoint   <span class="comment">--保存事务点</span></span><br><span class="line"></span><br><span class="line">………..代码……….</span><br><span class="line"></span><br><span class="line">      <span class="keyword">IF</span>(<span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> TOP <span class="number">1</span> * <span class="keyword">FROM</span> dbo.test <span class="keyword">WHERE</span> <span class="keyword">ID</span>=@<span class="keyword">ID</span>))    </span><br><span class="line"></span><br><span class="line">       <span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">               <span class="keyword">ROLLBACK</span> TRAN tranpoint ;   <span class="comment">--回滚保存点的事务   </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">             RETURN 0 ;  </span><br><span class="line">       <span class="keyword">END</span></span><br></pre></td></tr></table></figure><p>but。。。。。<img src="D:%5CBlog%5Candersen666Blog%5Csource_posts%5C%E4%BA%8B%E5%8A%A1%E4%B8%8E%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1%5C%E4%BA%8B%E5%8A%A110.png" alt="loading"></p><p>好消息是报错减少一个，再次观察，我们虽然保存了返回点，但是没有注意到  ROOLBACK返回值 @@TRANCOUNT值是不变化的。所以可以看到的 再回滚子事务后  @@TRANCOUNT依旧是2，</p><p>但是明明 在父事务中当时begin 是  @@TRANCOUNT是1 这样，但是你进入了一个子存储变2了，应该是0呀，sql就会报错。</p><p><strong>理所当然我们第一时间想到的是，既然ROOLBACK返回保存点不变话，当然，再将其提交不就ok</strong></p><p>再次修改代码</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">BEGIN</span> TRAN tran1      <span class="comment">--开始事务 </span></span><br><span class="line">       <span class="keyword">SAVE</span> TRAN tranpoint   <span class="comment">--保存事务点</span></span><br><span class="line">………..代码……….</span><br><span class="line"></span><br><span class="line"> <span class="keyword">IF</span>(<span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> TOP <span class="number">1</span> * <span class="keyword">FROM</span> dbo.test <span class="keyword">WHERE</span> <span class="keyword">ID</span>=@<span class="keyword">ID</span>))    </span><br><span class="line">        <span class="keyword">BEGIN</span></span><br><span class="line">                <span class="keyword">ROLLBACK</span> TRAN tranpoint ;   <span class="comment">--回滚保存点的事务   </span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">COMMIT</span> TRAN tran1 ;            <span class="comment">--提示当前事务</span></span><br><span class="line">                          </span><br><span class="line">                RETURN 0 ;  </span><br><span class="line">        <span class="keyword">END</span></span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/c44b3fe4gy1g5fngtwwewj20jf06umxo.jpg" alt></p><p>well done </p><p>这是完全正确状态。我们可以看一个关键点，，就是进入子事务后只是回滚还是2，但是回滚后提交便是1，所以想到的就是先提交内部事务</p>]]></content>
      
      
      <categories>
          
          <category> SQL SERVER </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>博客更新日志及踩坑记录</title>
      <link href="/2019/07/17/blog-update/"/>
      <url>/2019/07/17/blog-update/</url>
      
        <content type="html"><![CDATA[<h4 id="博客更新日志及踩坑记录"><a href="#博客更新日志及踩坑记录" class="headerlink" title="博客更新日志及踩坑记录"></a>博客更新日志及踩坑记录</h4><h5 id="博客更新日志"><a href="#博客更新日志" class="headerlink" title="博客更新日志"></a>博客更新日志</h5><p><strong>2019-7-15</strong>  完成github+nexo基本搭建</p><p><strong>2019-7-16</strong>  完成next主题的更换与美化</p><p><strong>2019-7-17</strong>  完成博客后期的调整等</p><p><strong>2019-7-18</strong> 添加来必力评论系统</p><h5 id="踩坑记录"><a href="#踩坑记录" class="headerlink" title="踩坑记录"></a>踩坑记录</h5><ul><li>我们需要注意的是，每个关键字冒号后需要空格，例如 categories: 博客相关   categories:后需要空格，否则在 hexo s 后无法进行预览</li></ul><ul><li>在域名与github绑定后首次没有问题，但是当更新博客内容，hexo d后就会出现域名丢失，这时候我们无法通过域名进入博客，只能通过<a href="mailto:yourname@github.io" target="_blank" rel="noopener">yourname@github.io</a> 进入博客，这是因为每次在hexo d 就会更新就会将CNAME值更新删除，所以我们可以在本地用sublime在source文件夹下方新建自己域名值 ，例如 xushang.xyz 保存为全部文件。</li></ul><p><em>未完待续</em></p>]]></content>
      
      
      <categories>
          
          <category> 博客相关 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2019/07/15/hello-world/"/>
      <url>/2019/07/15/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="hello-hexo"><a href="#hello-hexo" class="headerlink" title="hello hexo"></a>hello hexo</h2><ol><li><h1 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h1></li><li><p>xx</p></li></ol><h4 id="这是4级标题"><a href="#这是4级标题" class="headerlink" title="这是4级标题"></a>这是4级标题</h4><p><strong>字体加粗</strong></p><p><em>字体斜</em></p><ul><li>test1</li><li>test2</li><li>test3</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  * <span class="keyword">from</span>  <span class="keyword">test</span></span><br></pre></td></tr></table></figure><p><img src alt="loading"></p>]]></content>
      
      
      <categories>
          
          <category> 博客相关 </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
